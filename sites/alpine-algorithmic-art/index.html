<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Cpath d='M96 20 L172 60 L172 132 L96 172 L20 132 L20 60 Z' fill='%23d97757'/%3E%3Ccircle cx='96' cy='96' r='30' fill='%23faf9f5'/%3E%3C/svg%3E">
    <title>Alpine Algorithmic Art</title>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.1/dist/cdn.min.js"></script>
    <!-- p5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Lora:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* Anthropic Brand Colors */
        :root {
            --anthropic-dark: #141413;
            --anthropic-light: #faf9f5;
            --anthropic-mid-gray: #b0aea5;
            --anthropic-light-gray: #e8e6dc;
            --anthropic-orange: #d97757;
            --anthropic-blue: #6a9bcc;
            --anthropic-green: #788c5d;
            
            /* Light mode colors (default) */
            --bg-primary: #faf9f5;
            --bg-secondary: #f5f3ee;
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-input: #faf9f5;
            --bg-canvas: white;
            --text-primary: #141413;
            --text-secondary: #b0aea5;
            --border-color: #e8e6dc;
            --shadow-color: rgba(20, 20, 19, 0.1);
        }

        /* Dark mode colors */
        :root.dark {
            --bg-primary: #141413;
            --bg-secondary: #1a1a19;
            --bg-card: rgba(40, 40, 38, 0.95);
            --bg-input: #2a2a28;
            --bg-canvas: #1a1a19;
            --text-primary: #faf9f5;
            --text-secondary: #b0aea5;
            --border-color: #3a3a38;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        [x-cloak] { display: none; }

        .container {
            display: flex;
            min-height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            flex-shrink: 0;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-color);
            overflow-y: auto;
            max-height: calc(100vh - 40px);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .sidebar h1 {
            font-family: 'Lora', serif;
            font-size: 24px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .sidebar .subtitle {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
            line-height: 1.4;
            transition: color 0.3s ease;
        }

        /* Control Sections */
        .control-section {
            margin-bottom: 32px;
        }

        .control-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }

        .control-section h3::before {
            content: '•';
            color: var(--anthropic-orange);
            font-weight: bold;
        }

        /* Seed Controls */
        .seed-input {
            width: 100%;
            background: var(--bg-input);
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-primary);
            transition: background 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }

        .seed-input:focus {
            outline: none;
            border-color: var(--anthropic-orange);
            box-shadow: 0 0 0 2px rgba(217, 119, 87, 0.1);
        }

        .seed-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        /* Parameter Controls */
        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            transition: background 0.3s ease;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--anthropic-orange);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            background: #c86641;
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--anthropic-orange);
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .value-display {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            min-width: 60px;
            text-align: right;
            transition: color 0.3s ease;
        }

        /* Buttons */
        .button {
            background: var(--anthropic-orange);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .button:hover {
            background: #c86641;
            transform: translateY(-1px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.secondary {
            background: var(--anthropic-blue);
        }

        .button.secondary:hover {
            background: #5a8bb8;
        }

        .button.tertiary {
            background: var(--anthropic-green);
        }

        .button.tertiary:hover {
            background: #6b7b52;
        }

        .button-row {
            display: flex;
            gap: 8px;
        }

        .button-row .button {
            flex: 1;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
        }

        #canvas-container {
            width: 100%;
            max-width: 1000px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 40px var(--shadow-color);
            background: var(--bg-canvas);
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        #canvas-container canvas {
            display: block;
            width: 100% !important;
            height: auto !important;
        }

        /* Status indicator */
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Dark mode toggle button */
        .dark-mode-toggle {
            position: relative;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-input);
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .dark-mode-toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: color 0.3s ease;
        }
        
        .dark-mode-toggle-button {
            background: var(--anthropic-orange);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .dark-mode-toggle-button:hover {
            background: #c86641;
            transform: translateY(-1px);
        }
        
        .dark-mode-icon {
            font-size: 16px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--anthropic-green);
        }

        .status-dot.offline {
            background: var(--anthropic-orange);
        }

        /* Responsive - Stack on mobile */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: none;
            }
        }
    </style>
</head>
<body>
    <div x-data="artApp()" x-cloak class="container">
        <!-- Control Sidebar -->
        <div class="sidebar">
            <h1>Alpine Algorithmic Art</h1>
            <div class="subtitle">Explore generative art through code and mathematics</div>

            <!-- Status -->
            <div class="status">
                <div class="status-dot" :class="{ 'offline': !online }"></div>
                <span x-text="online ? 'Online' : 'Offline - Data saved locally'"></span>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="dark-mode-toggle">
                <div class="dark-mode-toggle-label">
                    <span x-show="!darkMode" class="dark-mode-icon">☀️</span>
                    <span x-show="darkMode" class="dark-mode-icon">🌙</span>
                    <span x-text="darkMode ? 'Dark Mode' : 'Light Mode'"></span>
                </div>
                <button 
                    class="dark-mode-toggle-button" 
                    @click="toggleDarkMode()"
                    :aria-label="darkMode ? 'Switch to light mode' : 'Switch to dark mode'">
                    <span x-text="darkMode ? 'Light' : 'Dark'"></span>
                </button>
            </div>

            <!-- Seed Section -->
            <div class="control-section">
                <h3>Seed</h3>
                <input 
                    type="number" 
                    class="seed-input" 
                    x-model.number="seed"
                    @change="regenerate()">
                <div class="seed-controls">
                    <button class="button secondary" @click="previousSeed()">← Prev</button>
                    <button class="button secondary" @click="nextSeed()">Next →</button>
                </div>
                <button class="button tertiary" @click="randomSeed()">↻ Random</button>
            </div>

            <!-- Parameters Section -->
            <div class="control-section">
                <h3>Parameters</h3>
                
                <!-- Particle Count -->
                <div class="control-group">
                    <label>Particle Count</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            min="500" 
                            max="5000" 
                            step="100" 
                            x-model.number="particleCount"
                            @input="updateParam()">
                        <span class="value-display" x-text="particleCount"></span>
                    </div>
                </div>

                <!-- Flow Speed -->
                <div class="control-group">
                    <label>Flow Speed</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            min="0.1" 
                            max="3.0" 
                            step="0.1" 
                            x-model.number="flowSpeed"
                            @input="updateParam()">
                        <span class="value-display" x-text="flowSpeed.toFixed(1)"></span>
                    </div>
                </div>

                <!-- Noise Scale -->
                <div class="control-group">
                    <label>Noise Scale</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            min="0.001" 
                            max="0.02" 
                            step="0.001" 
                            x-model.number="noiseScale"
                            @input="updateParam()">
                        <span class="value-display" x-text="noiseScale.toFixed(3)"></span>
                    </div>
                </div>

                <!-- Trail Opacity -->
                <div class="control-group">
                    <label>Trail Opacity</label>
                    <div class="slider-container">
                        <input 
                            type="range" 
                            min="1" 
                            max="20" 
                            step="1" 
                            x-model.number="trailOpacity"
                            @input="updateParam()">
                        <span class="value-display" x-text="trailOpacity"></span>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <div class="control-section">
                <h3>Actions</h3>
                <div class="button-row">
                    <button class="button" @click="reset()">Reset</button>
                    <button class="button secondary" @click="saveImage()">Save PNG</button>
                </div>
            </div>
        </div>

        <!-- Main Canvas Area -->
        <div class="canvas-area">
            <div id="canvas-container"></div>
        </div>
    </div>

    <script>
        // Alpine.js App Component
        function artApp() {
            return {
                // State
                seed: 12345,
                particleCount: 2000,
                flowSpeed: 1.0,
                noiseScale: 0.005,
                trailOpacity: 5,
                online: navigator.onLine,
                darkMode: false,

                // Defaults for reset
                defaults: {
                    seed: 12345,
                    particleCount: 2000,
                    flowSpeed: 1.0,
                    noiseScale: 0.005,
                    trailOpacity: 5
                },

                init() {
                    // Load saved preferences
                    this.loadPreferences();
                    
                    // Detect system preference if no saved preference
                    if (localStorage.getItem('art-dark-mode') === null) {
                        this.detectSystemPreference();
                    }
                    
                    // Apply dark mode class
                    this.updateDarkMode();

                    // Initialize p5.js with Alpine context
                    window.alpineApp = this;
                    
                    // Listen for online/offline events
                    window.addEventListener('online', () => { this.online = true; });
                    window.addEventListener('offline', () => { this.online = false; });
                    
                    // Listen for system preference changes
                    if (window.matchMedia) {
                        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                        mediaQuery.addEventListener('change', (e) => {
                            // Only auto-update if user hasn't set a preference
                            if (localStorage.getItem('art-dark-mode') === null) {
                                this.darkMode = e.matches;
                                this.updateDarkMode();
                            }
                        });
                    }
                },

                loadPreferences() {
                    const saved = localStorage.getItem('art-preferences');
                    if (saved) {
                        try {
                            const prefs = JSON.parse(saved);
                            Object.assign(this, prefs);
                        } catch (e) {
                            console.log('Could not load preferences');
                        }
                    }
                    
                    // Load dark mode preference separately
                    const darkModeSaved = localStorage.getItem('art-dark-mode');
                    if (darkModeSaved !== null) {
                        this.darkMode = darkModeSaved === 'true';
                    }
                },

                savePreferences() {
                    const prefs = {
                        seed: this.seed,
                        particleCount: this.particleCount,
                        flowSpeed: this.flowSpeed,
                        noiseScale: this.noiseScale,
                        trailOpacity: this.trailOpacity
                    };
                    localStorage.setItem('art-preferences', JSON.stringify(prefs));
                },
                
                detectSystemPreference() {
                    if (window.matchMedia) {
                        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                        this.darkMode = mediaQuery.matches;
                    }
                },
                
                toggleDarkMode() {
                    this.darkMode = !this.darkMode;
                    this.updateDarkMode();
                    localStorage.setItem('art-dark-mode', this.darkMode.toString());
                },
                
                updateDarkMode() {
                    if (this.darkMode) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },

                regenerate() {
                    this.savePreferences();
                    if (window.initializeArt) {
                        window.initializeArt();
                    }
                },

                updateParam() {
                    this.savePreferences();
                    if (window.updateParams) {
                        window.updateParams();
                    }
                },

                previousSeed() {
                    this.seed = Math.max(1, this.seed - 1);
                    this.regenerate();
                },

                nextSeed() {
                    this.seed++;
                    this.regenerate();
                },

                randomSeed() {
                    this.seed = Math.floor(Math.random() * 999999) + 1;
                    this.regenerate();
                },

                reset() {
                    Object.assign(this, this.defaults);
                    this.regenerate();
                },

                saveImage() {
                    if (window.saveCanvas) {
                        saveCanvas('alpine-art-' + this.seed, 'png');
                    }
                }
            };
        }

        // ═══════════════════════════════════════════════════════════════════════
        // P5.JS GENERATIVE ART ALGORITHM - Organic Flow Fields
        // ═══════════════════════════════════════════════════════════════════════

        let particles = [];
        let flowField = [];
        let cols, rows;
        const scl = 10;

        function setup() {
            let canvas = createCanvas(800, 800);
            canvas.parent('canvas-container');
            initializeArt();
        }

        function initializeArt() {
            const app = window.alpineApp;
            
            // Seed the randomness
            randomSeed(app.seed);
            noiseSeed(app.seed);

            // Clear and recreate particles
            particles = [];
            for (let i = 0; i < app.particleCount; i++) {
                particles.push(new Particle());
            }

            // Generate flow field
            cols = floor(width / scl);
            rows = floor(height / scl);
            generateFlowField();

            // Clear background - use dark mode aware color
            const bgColor = app.darkMode ? [26, 26, 25] : [250, 249, 245];
            background(bgColor[0], bgColor[1], bgColor[2]);
        }

        function generateFlowField() {
            const app = window.alpineApp;
            flowField = [];
            
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    let index = x + y * cols;
                    let angle = noise(x * app.noiseScale, y * app.noiseScale) * TWO_PI * 4;
                    let v = p5.Vector.fromAngle(angle);
                    v.setMag(1);
                    flowField[index] = v;
                }
            }
        }

        function updateParams() {
            generateFlowField();
        }

        function draw() {
            const app = window.alpineApp;
            
            // Semi-transparent background for trails - use dark mode aware color
            const bgColor = app.darkMode ? [26, 26, 25] : [250, 249, 245];
            fill(bgColor[0], bgColor[1], bgColor[2], app.trailOpacity);
            noStroke();
            rect(0, 0, width, height);

            // Update and display particles
            for (let particle of particles) {
                particle.follow(flowField);
                particle.update();
                particle.edges();
                particle.show();
            }
        }

        class Particle {
            constructor() {
                this.pos = createVector(random(width), random(height));
                this.vel = createVector(0, 0);
                this.acc = createVector(0, 0);
                this.maxSpeed = 2;
                this.prevPos = this.pos.copy();
                
                // Particle color based on position
                this.hue = random(360);
                this.alpha = random(50, 150);
            }

            follow(vectors) {
                const app = window.alpineApp;
                let x = floor(this.pos.x / scl);
                let y = floor(this.pos.y / scl);
                let index = x + y * cols;
                let force = vectors[index];
                if (force) {
                    this.applyForce(force);
                }
            }

            applyForce(force) {
                this.acc.add(force);
            }

            update() {
                const app = window.alpineApp;
                this.vel.add(this.acc);
                this.vel.limit(this.maxSpeed * app.flowSpeed);
                this.pos.add(this.vel);
                this.acc.mult(0);
            }

            show() {
                // Use Anthropic color palette
                const colors = [
                    [217, 119, 87],  // orange
                    [106, 155, 204], // blue
                    [120, 140, 93],  // green
                    [176, 174, 165]  // mid-gray
                ];
                
                let colorIndex = floor(map(noise(this.pos.x * 0.01, this.pos.y * 0.01), 0, 1, 0, colors.length));
                let c = colors[colorIndex];
                
                stroke(c[0], c[1], c[2], this.alpha);
                strokeWeight(1);
                line(this.pos.x, this.pos.y, this.prevPos.x, this.prevPos.y);
                this.updatePrev();
            }

            updatePrev() {
                this.prevPos.x = this.pos.x;
                this.prevPos.y = this.pos.y;
            }

            edges() {
                if (this.pos.x > width) {
                    this.pos.x = 0;
                    this.updatePrev();
                }
                if (this.pos.x < 0) {
                    this.pos.x = width;
                    this.updatePrev();
                }
                if (this.pos.y > height) {
                    this.pos.y = 0;
                    this.updatePrev();
                }
                if (this.pos.y < 0) {
                    this.pos.y = height;
                    this.updatePrev();
                }
            }
        }

        // Make functions available globally
        window.initializeArt = initializeArt;
        window.updateParams = updateParams;
    </script>

    <!-- PWA Setup -->
    <script>
        const iconSize = 192;
        const manifest = {
            name: 'Alpine Algorithmic Art',
            short_name: 'Alpine Art',
            description: 'Explore generative art through code and mathematics',
            display: 'standalone',
            theme_color: '#d97757',
            background_color: '#faf9f5',
            start_url: '.',
            icons: []
        };

        (async function() {
            const svgIconLink = document.querySelector('link[rel="icon"]');
            const pngDataUrl = await svgToPng(svgIconLink.href, iconSize);
            
            setIcon("link[rel='icon']", pngDataUrl, iconSize);
            setIcon("link[rel='apple-touch-icon']", pngDataUrl);
            
            manifest.icons = [{
                src: pngDataUrl,
                sizes: `${iconSize}x${iconSize}`,
                type: 'image/png',
                purpose: 'any maskable'
            }];
            
            setManifest(manifest);
            
            const startupImageDataUrl = await createStartupImage(
                svgIconLink.href,
                manifest.background_color
            );
            const startupLink = document.createElement('link');
            startupLink.rel = 'apple-touch-startup-image';
            startupLink.href = startupImageDataUrl;
            document.head.appendChild(startupLink);
        })();

        function setManifest(manifest) {
            const link = document.createElement('link');
            link.rel = 'manifest';
            const b64manifest = btoa(JSON.stringify(manifest));
            link.href = "data:application/json;base64," + b64manifest;
            document.head.appendChild(link);
        }

        function setIcon(query, iconUrl, size) {
            const iconLink = document.querySelector(query);
            iconLink.href = iconUrl;
            iconLink.type = 'image/png';
            if (size) iconLink.setAttribute('sizes', `${size}x${size}`);
        }

        function svgToPng(svgDataUrl, size) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, size, size);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = reject;
                img.src = svgDataUrl;
            });
        }

        function createStartupImage(svgDataUrl, bgColor) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const dpr = window.devicePixelRatio || 1;
                    const canvas = document.createElement('canvas');
                    canvas.width = window.screen.width * dpr;
                    canvas.height = window.screen.height * dpr;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = bgColor;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    const iconDisplaySize = canvas.width * 0.25;
                    const x = (canvas.width - iconDisplaySize) / 2;
                    const y = (canvas.height - iconDisplaySize) / 2;
                    ctx.drawImage(img, x, y, iconDisplaySize, iconDisplaySize);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = reject;
                img.src = svgDataUrl;
            });
        }
    </script>
</body>
</html>
