<!doctype html>
<html lang="en" data-theme="light" data-view="full">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>__NAME__ — Resume</title>
<meta name="description" content="Resume for __NAME__"/>
<style>
:root {
  --bg: #ffffff;
  --fg: #0b1220;
  --muted: #4b5563;
  --card: #f6f7fb;
  --border: rgba(0,0,0,.10);
  --accent: #2563eb;
  --accent2: #16a34a;
  --shadow: 0 10px 30px rgba(2, 6, 23, .10);
  --ring: 0 0 0 3px rgba(37, 99, 235, .25);
  --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}
html[data-theme="dark"] {
  --bg: #0b1220;
  --fg: #e5e7eb;
  --muted: #a1a1aa;
  --card: rgba(255,255,255,.06);
  --border: rgba(255,255,255,.14);
  --accent: #60a5fa;
  --accent2: #4ade80;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
  --ring: 0 0 0 3px rgba(96, 165, 250, .25);
}
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: var(--sans);
  background: var(--bg);
  color: var(--fg);
  line-height: 1.5;
}
a { color: var(--accent); }
a:focus-visible, button:focus-visible, input:focus-visible, summary:focus-visible {
  outline: none;
  box-shadow: var(--ring);
  border-radius: 10px;
}
.skip-link {
  position: absolute;
  left: -999px;
  top: 12px;
  background: var(--bg);
  color: var(--fg);
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 12px;
  z-index: 1000;
}
.skip-link:focus { left: 12px; }
header {
  position: sticky;
  top: 0;
  z-index: 50;
  background: color-mix(in oklab, var(--bg) 92%, transparent);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
}
.toolbar {
  max-width: 1160px;
  margin: 0 auto;
  padding: 12px 16px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 10px;
}
@media (min-width: 860px) {
  .toolbar {
    grid-template-columns: 220px 1fr auto;
    align-items: center;
  }
}
.brand {
  display: flex;
  gap: 10px;
  align-items: center;
}
.brand .dot {
  width: 12px; height: 12px; border-radius: 999px;
  background: var(--accent);
  box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 20%, transparent);
}
.brand .title {
  font-weight: 750;
  letter-spacing: .2px;
}
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  justify-content: flex-start;
}
.control {
  border: 1px solid var(--border);
  background: color-mix(in oklab, var(--card) 80%, transparent);
  color: var(--fg);
  padding: 10px 12px;
  border-radius: 14px;
  box-shadow: none;
  cursor: pointer;
}
.control:hover { border-color: color-mix(in oklab, var(--border) 30%, var(--accent)); }
.control[aria-pressed="true"] { border-color: color-mix(in oklab, var(--accent) 55%, var(--border)); }
.search-wrap { display: flex; gap: 8px; align-items: center; }
.search {
  width: min(520px, 100%);
  border: 1px solid var(--border);
  background: color-mix(in oklab, var(--card) 70%, transparent);
  color: var(--fg);
  padding: 10px 12px;
  border-radius: 14px;
}
main {
  max-width: 1160px;
  margin: 0 auto;
  padding: 18px 16px 56px;
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}
@media (min-width: 860px) {
  main { grid-template-columns: 260px 1fr; align-items: start; }
}
nav {
  position: sticky;
  top: 96px;
  align-self: start;
  border: 1px solid var(--border);
  background: color-mix(in oklab, var(--card) 70%, transparent);
  border-radius: 18px;
  padding: 12px;
  box-shadow: var(--shadow);
}
.nav-title { font-size: 14px; font-weight: 700; color: var(--muted); letter-spacing: .2px; margin: 0 0 10px; }
.navlist { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }
.navlist a {
  display: block; text-decoration: none; padding: 8px 10px; border-radius: 12px;
  border: 1px solid transparent; color: var(--fg);
}
.navlist a:hover { background: color-mix(in oklab, var(--accent) 10%, transparent); }
.navlist a[aria-current="true"] {
  border-color: color-mix(in oklab, var(--accent) 40%, transparent);
  background: color-mix(in oklab, var(--accent) 14%, transparent);
}
.mobile-nav { display: block; }
@media (min-width: 860px) { .mobile-nav { display: none; } }
.desktop-nav { display: none; }
@media (min-width: 860px) { .desktop-nav { display: block; } }

.content {
  border: 1px solid var(--border);
  background: color-mix(in oklab, var(--card) 65%, transparent);
  border-radius: 22px;
  padding: 18px;
  box-shadow: var(--shadow);
  overflow: hidden;
}
.page { transition: opacity .22s ease, transform .22s ease; }
.view-transition-out { opacity: 0; transform: translateY(6px); }
@media (prefers-reduced-motion: reduce) { .page { transition: none; } }

h1 { font-size: clamp(28px, 2.2vw, 40px); line-height: 1.12; margin: 0 0 6px; }
h2 { font-size: 20px; margin: 22px 0 10px; padding-top: 6px; }
h3 { font-size: 16px; margin: 18px 0 6px; }
.meta { color: var(--muted); display: flex; flex-wrap: wrap; gap: 10px; margin: 0 0 10px; }
.pills { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0 0; }
.pill {
  border: 1px solid var(--border); border-radius: 999px; padding: 6px 10px; font-size: 13px;
  background: color-mix(in oklab, var(--card) 70%, transparent);
}
.section { border-top: 1px dashed var(--border); padding-top: 14px; margin-top: 14px; }
.card {
  border: 1px solid var(--border); border-radius: 18px; padding: 14px 14px;
  background: color-mix(in oklab, var(--bg) 40%, transparent);
  margin: 10px 0 0;
}
.job-head { display: flex; flex-wrap: wrap; gap: 8px 12px; align-items: baseline; justify-content: space-between; }
.job-title { font-weight: 760; }
.job-sub { color: var(--muted); font-size: 14px; }
ul { margin: 8px 0 0 18px; }
li { margin: 6px 0; }
details {
  margin-top: 10px; border: 1px solid var(--border); border-radius: 14px;
  padding: 8px 10px; background: color-mix(in oklab, var(--card) 70%, transparent);
}
summary { cursor: pointer; font-weight: 650; }
code {
  font-family: var(--mono); font-size: 0.95em; padding: 0 6px; border: 1px solid var(--border);
  border-radius: 10px; background: color-mix(in oklab, var(--card) 70%, transparent);
}
mark { padding: 0 .15em; border-radius: .25em; }

.full-only { display: block; }
.short-only { display: none; }
html[data-view="short"] .full-only { display: none; }
html[data-view="short"] .short-only { display: block; }

@media print {
  header, nav.desktop-nav, .mobile-nav, .controls, .search-wrap { display: none !important; }
  main { grid-template-columns: 1fr; padding: 0; }
  .content { box-shadow: none; border: none; padding: 0; background: #fff; }
  body { background: #fff; color: #000; }
  a { color: #000; text-decoration: underline; }
  details { border: 1px solid #ddd; }
}
</style>
</head>
<body>
<a class="skip-link" href="#top">Skip to content</a>

<header>
  <div class="toolbar">
    <div class="brand" aria-label="Resume toolbar">
      <span class="dot" aria-hidden="true"></span>
      <div>
        <div class="title">__NAME__</div>
        <div class="job-sub short-only">Two-page view</div>
        <div class="job-sub full-only">Full view</div>
      </div>
    </div>

    <div class="search-wrap">
      <input id="search" class="search" type="search" placeholder="Search (press /) — highlights and filters" aria-label="Search resume"/>
      <button id="clearSearch" class="control" type="button">Clear</button>
    </div>

    <div class="controls" role="toolbar" aria-label="Display controls">
      <button id="homeBtn" class="control" type="button">Home</button>
      <button id="viewBtn" class="control" type="button" aria-pressed="false" aria-label="Toggle between two-page and full view">Two-page</button>
      <button id="themeBtn" class="control" type="button" aria-pressed="false" aria-label="Toggle dark mode">Dark</button>
      <button id="printBtn" class="control" type="button" title="Print / Save as PDF">Print</button>
      <button id="menuBtn" class="control mobile-nav" type="button" aria-expanded="false" aria-controls="mobileNav">Menu</button>
    </div>
  </div>
</header>

<main>
  <nav class="desktop-nav" aria-label="Section navigation">
    <div class="nav-title">Navigate</div>
    <ul class="navlist" id="navList"></ul>
  </nav>

  <div class="content" id="top">
    <div class="page" id="page"></div>

    <nav class="mobile-nav" id="mobileNav" hidden aria-label="Section navigation">
      <div class="nav-title">Navigate</div>
      <ul class="navlist" id="navListMobile"></ul>
    </nav>
  </div>
</main>

<script id="resume-data" type="application/json">__JSON__</script>
<script>
(function(){
  const data = JSON.parse(document.getElementById('resume-data').textContent);
  const $ = (sel) => document.querySelector(sel);

  const state = {
    theme: localStorage.getItem('resume_theme') || 'light',
    view: localStorage.getItem('resume_view') || 'short',
    query: ''
  };
  document.documentElement.setAttribute('data-theme', state.theme);
  document.documentElement.setAttribute('data-view', state.view);

  function slugify(s) {
    return s.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
  }
  function escapeHtml(str) {
    return String(str)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }
  function inlineMd(text) {
    let t = escapeHtml(text || '');
    t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
    t = t.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    t = t.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
    return t;
  }

  // Two-page logic (documented in README):
  // - Keep newest 3 "jobs" (includes sabbatical).
  // - Keep at most 3 bullets per group.
  // - Summarize older employers under "Earlier Experience".
  function buildShortModel(full) {
    const keepJobs = full.work.slice(0, 3);
    const rest = full.work.slice(3);
    const olderCompanies = rest
      .filter(j => j.company)
      .map(j => j.company)
      .filter((v,i,a)=>a.indexOf(v)===i);

    const shortJobs = keepJobs.map(j => {
      const groups = (j.groups || [])
        .map(g => ({
          heading: g.heading,
          bullets: (g.bullets || []).slice(0, 3)
        }))
        .filter(g => (g.heading || (g.bullets && g.bullets.length)));
      return { ...j, groups };
    });

    return { ...full, work: shortJobs, short_extra: { olderCompanies } };
  }
  const shortData = buildShortModel(data);

  function render(model, isShort) {
    const root = $('#page');

    const contact = (model.contact || []).map(c => `<span>${escapeHtml(c)}</span>`).join(' · ');
    const meta = (model.meta || []).map(m => `<span class="pill">${inlineMd(m)}</span>`).join('');
    const links = (model.links || []).map(l => `<a href="${escapeHtml(l.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(l.label)}</a>`).join(' · ');

    const skillsBlocks = Object.entries(model.skills || {})
      .map(([k,v]) => `
        <div class="card">
          <div class="job-title">${escapeHtml(k)}</div>
          <div class="job-sub">${inlineMd(v)}</div>
        </div>
      `).join('');

    const edu = (model.education || []).map(line => `<div>${inlineMd(line)}</div>`).join('');

    const jobs = (model.work || []).map((j, idx) => {
      const jobId = `job-${idx}-${slugify((j.company || j.title) + '-' + j.dates)}`;
      const groups = (j.groups || []).map(g => `
        ${g.heading ? `<h3>${escapeHtml(g.heading)}</h3>` : ``}
        <ul>
          ${(g.bullets || []).map(b => `<li>${inlineMd(b)}</li>`).join('')}
        </ul>
      `).join('');

      const companyDetails = (j.company_desc && j.company_desc.trim().length)
        ? `
          <details>
            <summary>Company overview</summary>
            <div class="job-sub" style="margin-top:8px">${inlineMd(j.company_desc)}</div>
          </details>
        ` : '';

      return `
        <section class="section" id="${jobId}" data-searchable="true">
          <div class="card">
            <div class="job-head">
              <div>
                <div class="job-title">${escapeHtml(j.title)}</div>
                <div class="job-sub"><strong>${escapeHtml(j.company)}</strong> · ${escapeHtml(j.location)} · ${escapeHtml(j.dates)}</div>
              </div>
            </div>
            ${companyDetails}
            ${groups}
          </div>
        </section>
      `;
    }).join('');

    const shortExtra = (isShort && model.short_extra && model.short_extra.olderCompanies && model.short_extra.olderCompanies.length)
      ? `
        <section class="section short-only" id="earlier-experience" data-searchable="true">
          <h2>Earlier Experience</h2>
          <div class="card">
            <div class="job-sub">Additional roles at: <strong>${model.short_extra.olderCompanies.map(escapeHtml).join(', ')}</strong></div>
          </div>
        </section>
      ` : '';

    root.innerHTML = `
      <section id="home" data-searchable="true">
        <h1>${escapeHtml(model.name)}</h1>
        <p class="meta">${contact}</p>
        <p class="meta">${links}</p>
        <div class="pills">${meta}</div>
      </section>

      <section class="section" id="summary" data-searchable="true">
        <h2>Summary</h2>
        <div class="card">
          <div>${inlineMd(model.summary)}</div>
        </div>
      </section>

      <section class="section" id="work-experience" data-searchable="true">
        <h2>Work Experience</h2>
        ${jobs}
        ${shortExtra}
      </section>

      <section class="section" id="education" data-searchable="true">
        <h2>Education</h2>
        <div class="card">${edu}</div>
      </section>

      <section class="section" id="skills" data-searchable="true">
        <h2>Skills</h2>
        ${skillsBlocks}
      </section>

      <section class="section" id="footer" aria-label="Footer">
        <div class="job-sub">Generated: ${escapeHtml(model.generated_at)} · Source of truth: Markdown</div>
      </section>
    `;

    buildNav();
    applySearch(state.query);
  }

  function buildNav() {
    const anchors = [
      { id: 'top', label: 'Home' },
      { id: 'summary', label: 'Summary' },
      { id: 'work-experience', label: 'Work Experience' },
      { id: 'education', label: 'Education' },
      { id: 'skills', label: 'Skills' },
    ];
    document.querySelectorAll('section[id^="job-"]').forEach(sec => {
      const title = sec.querySelector('.job-title')?.textContent?.trim() || sec.id;
      anchors.push({ id: sec.id, label: title });
    });

    const navHtml = anchors.map(a => `<li><a href="#${a.id}" data-target="${a.id}">${escapeHtml(a.label)}</a></li>`).join('');
    $('#navList').innerHTML = navHtml;
    $('#navListMobile').innerHTML = navHtml;

    function wire(listEl) {
      listEl.querySelectorAll('a[href^="#"]').forEach(a => {
        a.addEventListener('click', (e) => {
          const id = a.getAttribute('data-target') || a.getAttribute('href').slice(1);
          const el = document.getElementById(id);
          if(el) {
            e.preventDefault();
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            if(listEl.id === 'navListMobile') closeMobileNav();
          }
        });
      });
    }
    wire($('#navList'));
    wire($('#navListMobile'));

    const observed = anchors.map(a => document.getElementById(a.id)).filter(Boolean);
    const io = new IntersectionObserver((entries) => {
      const visible = entries.filter(e=>e.isIntersecting).sort((a,b)=>b.intersectionRatio-a.intersectionRatio)[0];
      if(!visible) return;
      const id = visible.target.id;
      document.querySelectorAll('.navlist a').forEach(a =>
        a.setAttribute('aria-current', a.getAttribute('data-target')===id ? 'true' : 'false')
      );
    }, { rootMargin: '-20% 0px -70% 0px', threshold: [0.2, 0.4, 0.6] });
    observed.forEach(el => io.observe(el));
  }

  function clearMarks(root) {
    root.querySelectorAll('mark').forEach(m => {
      const text = document.createTextNode(m.textContent);
      m.replaceWith(text);
    });
  }

  function applySearch(q) {
    state.query = q;
    const root = $('#page');
    clearMarks(root);

    const query = (q || '').trim();
    const blocks = Array.from(root.querySelectorAll('[data-searchable="true"], section[id^="job-"]'));
    if(!query) {
      blocks.forEach(b => b.hidden = false);
      return;
    }

    const qLower = query.toLowerCase();
    blocks.forEach(b => {
      const hay = b.textContent.toLowerCase();
      b.hidden = !hay.includes(qLower);
    });

    const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
      acceptNode(node) {
        if(!node.nodeValue) return NodeFilter.FILTER_REJECT;
        if(!node.parentElement) return NodeFilter.FILTER_REJECT;
        const tag = node.parentElement.tagName?.toLowerCase();
        if(['script','style','code'].includes(tag)) return NodeFilter.FILTER_REJECT;
        if(!node.nodeValue.toLowerCase().includes(qLower)) return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;
      }
    });
    const nodes = [];
    while(walker.nextNode()) nodes.push(walker.currentNode);

    const re = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'ig');
    nodes.forEach(node => {
      const text = node.nodeValue;
      const frag = document.createDocumentFragment();
      let last = 0;
      text.replace(re, (m, idx) => {
        frag.appendChild(document.createTextNode(text.slice(last, idx)));
        const mark = document.createElement('mark');
        mark.textContent = text.slice(idx, idx + m.length);
        frag.appendChild(mark);
        last = idx + m.length;
        return m;
      });
      frag.appendChild(document.createTextNode(text.slice(last)));
      node.parentNode.replaceChild(frag, node);
    });
  }

  function setView(nextView) {
    const page = $('#page');
    page.classList.add('view-transition-out');
    window.setTimeout(() => {
      state.view = nextView;
      localStorage.setItem('resume_view', nextView);
      document.documentElement.setAttribute('data-view', nextView);
      render(nextView === 'short' ? shortData : data, nextView === 'short');
      page.classList.remove('view-transition-out');
      updateButtons();
    }, 180);
  }

  function setTheme(nextTheme) {
    state.theme = nextTheme;
    localStorage.setItem('resume_theme', nextTheme);
    document.documentElement.setAttribute('data-theme', nextTheme);
    updateButtons();
  }

  function updateButtons() {
    const themeBtn = $('#themeBtn');
    const viewBtn = $('#viewBtn');
    const isDark = (state.theme === 'dark');
    const isShort = (state.view === 'short');
    themeBtn.textContent = isDark ? 'Light' : 'Dark';
    themeBtn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
    viewBtn.textContent = isShort ? 'Full' : 'Two-page';
    viewBtn.setAttribute('aria-pressed', isShort ? 'true' : 'false');
  }

  function openMobileNav() {
    const nav = $('#mobileNav');
    nav.hidden = false;
    $('#menuBtn').setAttribute('aria-expanded','true');
  }
  function closeMobileNav() {
    const nav = $('#mobileNav');
    nav.hidden = true;
    $('#menuBtn').setAttribute('aria-expanded','false');
  }
  function toggleMobileNav() {
    const nav = $('#mobileNav');
    if(nav.hidden) openMobileNav(); else closeMobileNav();
  }

  $('#themeBtn').addEventListener('click', () => setTheme(state.theme === 'dark' ? 'light' : 'dark'));
  $('#viewBtn').addEventListener('click', () => setView(state.view === 'short' ? 'full' : 'short'));
  $('#printBtn').addEventListener('click', () => window.print());

  // Fix: Home always scrolls to the true top of the page.
  $('#homeBtn').addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

  $('#menuBtn').addEventListener('click', toggleMobileNav);

  const search = $('#search');
  search.addEventListener('input', (e) => applySearch(e.target.value));
  $('#clearSearch').addEventListener('click', () => {
    search.value = '';
    applySearch('');
    search.focus();
  });

  document.addEventListener('keydown', (e) => {
    if(e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      e.preventDefault();
      search.focus();
    }
    if((e.key === 'Escape') && document.activeElement === search) {
      search.value = '';
      applySearch('');
      search.blur();
    }
    if((e.key === 'p' || e.key === 'P') && (e.metaKey || e.ctrlKey)) return;
    if(e.key === 'p' || e.key === 'P') {
      const tag = document.activeElement?.tagName?.toLowerCase();
      if(tag !== 'input' && tag !== 'textarea') window.print();
    }
  });

  updateButtons();
  render(state.view === 'short' ? shortData : data, state.view === 'short');
})();
</script>
</body>
</html>
